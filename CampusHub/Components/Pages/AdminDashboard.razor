@page "/admin/dashboard"
@layout Layout.AdminLayout

@using CampusHub.Application.DTO
@using CampusHub.Application.DTO.Admin
@using CampusHub.Application.DTO.Marketplace
@using CampusHub.Domain.Entities
@using CurrieTechnologies.Razor.SweetAlert2
@rendermode InteractiveServer

@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject SweetAlertService Swal
@inject CampusHub.Application.Interfaces.IAdminReportsService AdminReportsService
@inject CampusHub.Application.Interfaces.IAdminDashboardService AdminDashboardService
@inject NavigationManager Navigation

<main class="p-6">
    <section class="mb-6">
        <h2 class="font-bold text-base leading-5 mb-1">
            Welcome back, Admin! üëã
        </h2>
        <p class="text-xs text-gray-500 leading-4">
            Here's your UCC Campus Hub Admin Dashboard
        </p>
    </section>

    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <!-- Total Students Card -->
        <div class="border border-gray-200 rounded-lg p-6">
            <div class="flex justify-between items-start mb-3">
                <p class="text-xs font-semibold text-gray-700 leading-4">Total Students</p>
                <i class="fas fa-users text-gray-400 text-sm"></i>
            </div>
            <p class="font-bold text-2xl leading-7 mb-1">@(dashboardStats?.TotalStudents ?? 0)</p>
            <div class="flex items-center text-xs text-gray-500 leading-4">
                <i class="fas fa-users text-gray-400 text-[10px] mr-1"></i>
                <span class="text-gray-500 font-semibold">Registered users</span>
            </div>
        </div>

        <!-- Active Listings Card -->
        <div class="border border-gray-200 rounded-lg p-6">
            <div class="flex justify-between items-start mb-3">
                <p class="text-xs font-semibold text-gray-700 leading-4">Active Listings</p>
                <i class="fas fa-box text-gray-400 text-sm"></i>
            </div>
            <p class="font-bold text-2xl leading-7 mb-1">@(dashboardStats?.ActiveListings ?? 0)</p>
            <p class="text-xs text-gray-500 leading-4">Available marketplace items</p>
        </div>

        <!-- Published Events Card -->
        <div class="border border-gray-200 rounded-lg p-6">
            <div class="flex justify-between items-start mb-3">
                <p class="text-xs font-semibold text-gray-700 leading-4">Published Events</p>
                <i class="fas fa-calendar text-gray-400 text-sm"></i>
            </div>
            <p class="font-bold text-2xl leading-7 mb-1">@(dashboardStats?.PublishedEvents ?? 0)</p>
            <p class="text-xs text-gray-500 leading-4">Total events created</p>
        </div>

        <!-- Pending Reports Card -->
        <div class="border border-gray-200 rounded-lg p-6">
            <div class="flex justify-between items-start mb-3">
                <p class="text-xs font-semibold text-gray-700 leading-4">Pending Reports</p>
                <i class="fas fa-flag text-gray-400 text-sm"></i>
            </div>
            <p class="font-bold text-2xl leading-7 mb-1 text-[#E11D48]">@(dashboardStats?.PendingReports ?? 0)</p>
            <p class="text-xs text-gray-500 leading-4">Reports requiring attention</p>
        </div>
    </section>

    <!-- Charts Section -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Category Distribution Chart -->
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-bold text-sm leading-5 mb-1">Marketplace Category Distribution</h3>
            <p class="text-xs text-gray-500 leading-4 mb-4">Items by category across the marketplace</p>
            <div class="h-64">
                <canvas id="categoryChart"></canvas>
            </div>
            <div class="mt-4 grid grid-cols-2 gap-2 text-xs">
                @if (dashboardStats?.CategoryDistribution != null && dashboardStats.CategoryDistribution.Any())
                {
                    @for (int i = 0; i < dashboardStats.CategoryDistribution.Count; i++)
                    {
                        var category = dashboardStats.CategoryDistribution[i];
                        <div class="flex items-center">
                            <span class="w-3 h-3 rounded-full mr-2" style="background-color: @GetCategoryColor(i);"></span>
                            <span class="text-gray-700">@category.Category: @category.Percentage%</span>
                        </div>
                    }
                }
                else
                {
                    <div class="text-gray-500">No category data available</div>
                }
            </div>
        </div>

        <!-- College Distribution Chart -->
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-bold text-sm leading-5 mb-1">Students by College</h3>
            <p class="text-xs text-gray-500 leading-4 mb-4">Distribution of registered students across colleges</p>
            <div class="h-64">
                <canvas id="collegeChart"></canvas>
            </div>
        </div>
    </section>

    <!-- Quick Actions -->
    <section>
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-bold text-sm leading-5 mb-1">Quick Actions</h3>
            <p class="text-xs text-gray-500 leading-4 mb-4">Common administrative tasks</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <button @onclick="NavigateToEvents" class="border border-gray-200 rounded-md px-4 py-3 text-left text-xs font-semibold text-gray-700 hover:bg-gray-50 transition-colors flex items-center">
                    <i class="fas fa-calendar mr-2 text-gray-500"></i>
                    Create New Event
                </button>
                <button @onclick="NavigateToMarketplace" class="border border-gray-200 rounded-md px-4 py-3 text-left text-xs font-semibold text-gray-700 hover:bg-gray-50 transition-colors flex items-center">
                    <i class="fas fa-shopping-bag mr-2 text-gray-500"></i>
                    Review Marketplace Items
                </button>
                <button @onclick="NavigateToUsers" class="border border-gray-200 rounded-md px-4 py-3 text-left text-xs font-semibold text-gray-700 hover:bg-gray-50 transition-colors flex items-center">
                    <i class="fas fa-users mr-2 text-gray-500"></i>
                    Manage User Accounts
                </button>
            </div>
        </div>
    </section>
</main>

@code {
    private AdminDashboardStatsDto? dashboardStats;
    private string? errorMessage;
    private bool isLoading = true;

    private readonly string[] categoryColors = new[]
    {
        "#6CE22D", "#4CAF50", "#8BC34A", "#CDDC39", "#9E9E9E",
        "#FF9800", "#E91E63", "#9C27B0", "#3F51B5", "#2196F3"
    };

    protected override async Task OnInitializedAsync()
    {
        if (dashboardStats == null && string.IsNullOrEmpty(errorMessage))
        {
            try
            {
                var result = await AdminDashboardService.GetDashboardStatsAsync();
                if (result.IsSuccess)
                {
                    dashboardStats = result.Value;
                }
                else
                {
                    errorMessage = "Failed to load dashboard statistics";
                }
            }
            catch (Exception ex)
            {
                errorMessage = $"An error occurred: {ex.Message}";
                Console.WriteLine($"‚ùå Exception: {ex}");
            }
            finally
            {
                isLoading = false;
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                Console.WriteLine($"OnAfterRenderAsync - firstRender: {firstRender}");
                Console.WriteLine($"dashboardStats is null: {dashboardStats == null}");
                Console.WriteLine($"isLoading: {isLoading}");

                // Show error message if data failed to load
                if (!string.IsNullOrEmpty(errorMessage))
                {
                    await Swal.FireAsync("Error", errorMessage, SweetAlertIcon.Error);
                    return;
                }

                int attempts = 0;
                while (isLoading && attempts < 50) 
                {
                    await Task.Delay(100);
                    attempts++;
                }

                if (dashboardStats != null)
                {
                    Console.WriteLine("‚úì Calling adminDashboard.initWithData from Blazor");
                    Console.WriteLine($"‚úì Categories: {dashboardStats.CategoryDistribution?.Count ?? 0}, Colleges: {dashboardStats.CollegeDistribution?.Count ?? 0}");

                    await Task.Delay(200);

                    await JSRuntime.InvokeVoidAsync("adminDashboard.initWithData", dashboardStats);

                    Console.WriteLine("‚úì Charts initialization call completed");
                }
                else
                {
                    Console.WriteLine("‚ùå No dashboard stats available to initialize charts");
                }
            }
            catch (JSException ex)
            {
                Console.WriteLine($"‚ùå JS Interop Error: {ex.Message}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå Error in OnAfterRenderAsync: {ex.Message}");
            }
        }
    }

    private string GetCategoryColor(int index)
    {
        return categoryColors[index % categoryColors.Length];
    }

    private void NavigateToEvents()
    {
        Navigation.NavigateTo("/admin/events");
    }

    private void NavigateToMarketplace()
    {
        Navigation.NavigateTo("/admin/marketplace");
    }

    private void NavigateToUsers()
    {
        Navigation.NavigateTo("/admin/users");
    }
}
