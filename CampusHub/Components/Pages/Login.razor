@page "/login"
@page "/"
@using CampusHub.Application.DTO
@using CampusHub.Application.DTO.Common
@inject HttpClient HttpClient
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@using Microsoft.AspNetCore.Components.Authorization
@rendermode InteractiveServer
@inject IJSRuntime JSRuntime

<div class="login-container">
    <div class="login-card">
        <div class="login-header">
            <img alt="University of Caloocan City official logo with green ribbon and shield containing sun and torch"
                 class="university-logo"
                 height="80"
                 src="images/UCC_logo.png"
                 width="80" />
            <h1>Campus Hub</h1>
            <p class="login-subtitle">University of Caloocan City</p>
        </div>

        <div class="login-content">
            <div class="login-intro">
                <p class="portal-text">Portal Access</p>
            </div>

            <EditForm class="verification-form" Model="loginDto" OnValidSubmit="HandleValidSubmit" FormName="verification-form">
                <DataAnnotationsValidator />

                <div class="verification-header">
                    <h2 class="verification-title">Login</h2>
                    <p class="verification-description">Enter your username and password to access the platform</p>
                </div>

                <div class="form-group">
                    <label for="username">Username</label>
                    <InputText id="username" @bind-Value="loginDto.Username" />
                    <ValidationMessage For="@(() => loginDto.Username)" />
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <InputText id="password" type="password" @bind-Value="loginDto.Password" />
                    <ValidationMessage For="@(() => loginDto.Password)" />
                </div>

                <button class="btn btn-primary btn-large" type="submit" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span>Logging in...</span>
                    }
                    else
                    {
                        <span>Login</span>
                    }
                </button>

                <p class="signup-text">
                    Don't have an account?
                    <NavLink href="/register" style="color: var(--primary-green); text-decoration: none; font-weight: 500;">Sign Up</NavLink>
                </p>

                @if (!string.IsNullOrEmpty(loginError))
                {
                    <div class="badge badge-destructive">@loginError</div>
                }
                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <div class="badge badge-primary">@successMessage</div>
                }

                <ValidationSummary />
            </EditForm>
        </div>
    </div>
</div>

@code {
    private LoginDto loginDto = new LoginDto();
    private string loginError = string.Empty;
    private string successMessage = string.Empty;
    private bool isLoading = false;

    private async Task HandleValidSubmit()
    {
        loginError = string.Empty;
        successMessage = string.Empty;
        isLoading = true;

        try
        {
            Console.WriteLine($"Attempting login with username: {loginDto.Username}");
            var response = await HttpClient.PostAsJsonAsync("api/auth/login", loginDto);
            Console.WriteLine($"Login response status: {response.StatusCode}");

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResponseDto>();
                if (result != null)
                {
                    Console.WriteLine($"Login result - Role: {result.Role}, RedirectUrl: {result.RedirectUrl}");

                    // ADD THIS SECTION - Store user data in sessionStorage
                    await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "userId", result.UserId.ToString());
                    await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "username", result.Username);
                    await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "fullName", result.FullName);
                    await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "email", result.Email ?? "");
                    await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "role", result.Role);
                    Console.WriteLine("Session storage populated with user data");

                    successMessage = "Login successful! Redirecting...";
                    StateHasChanged();

                    await Task.Delay(500);

                    var redirectUrl = result.RedirectUrl ?? "/main-marketplace";
                    Console.WriteLine($"Attempting to navigate to: {redirectUrl}");

                    NavigationManager.NavigateTo(redirectUrl, forceLoad: true, replace: true);
                    Console.WriteLine("Navigation completed");
                }
                else
                {
                    Console.WriteLine("Login result was null");
                    loginError = "Invalid response from server.";
                }
            }
            else
            {
                Console.WriteLine($"Login failed with status: {response.StatusCode}");
                try
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    Console.WriteLine($"Error content: {errorContent}");
                    var errorResponse = JsonSerializer.Deserialize<JsonElement>(errorContent);

                    if (errorResponse.TryGetProperty("message", out var messageProperty))
                    {
                        loginError = messageProperty.GetString() ?? "Login failed. Please check your credentials.";
                    }
                    else
                    {
                        loginError = "Login failed. Please check your credentials.";
                    }
                }
                catch (Exception parseEx)
                {
                    Console.WriteLine($"Error parsing response: {parseEx.Message}");
                    loginError = response.StatusCode switch
                    {
                        System.Net.HttpStatusCode.Unauthorized => "Invalid credentials. Please check your username and password.",
                        System.Net.HttpStatusCode.BadRequest => "Invalid login data. Please check your input.",
                        _ => "Login failed. Please try again."
                    };
                }
            }
        }
        catch (HttpRequestException ex)
        {
            Console.WriteLine($"Network error during login: {ex.Message}");
            loginError = "Network error occurred. Please check your connection and try again.";
        }
        catch (TaskCanceledException ex)
        {
            Console.WriteLine($"Timeout during login: {ex.Message}");
            loginError = "The request timed out. Please try again.";
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Login error: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            loginError = "An unexpected error occurred. Please try again.";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // Response DTO to match the controller response
    public class LoginResponseDto
    {
        public int UserId { get; set; }
        public string Username { get; set; } = "";
        public string FullName { get; set; } = "";
        public string Role { get; set; } = "";
        public string? Email { get; set; }
        public bool IsSuccess { get; set; }
        public string Message { get; set; } = "";
        public string? RedirectUrl { get; set; }
    }
}